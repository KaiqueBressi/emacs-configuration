require 'logger'
require 'json'
require 'concurrent'
require 'httparty'

class Camunda
  include HTTParty

  logger ::Logger.new($stdout)

  base_uri 'https://api.stg.creditas.io/v0/journey-v2'
  headers 'Authorization' => "Bearer #{ENV.fetch('TOKEN')}", 'Content-Type' => 'application/json'
end

def tasks_filter
  JSON.dump(
    {
      "processDefinitionId" => "FluxoHome:27:5065fd29-f446-11e9-835f-0242ac110002",
      "taskDefinitionKey" => "Processamento",
      "unassigned" => true,
      "active" => true
    }
  )
end

def modify_body(process_instance_ids)
  JSON.dump(
    {
      "processDefinitionId" => "FluxoHome:27:5065fd29-f446-11e9-835f-0242ac110002",
      "instructions" => [
        {
          "type" => "cancel",
          "activityId" => "Processamento",
          "cancelCurrentActiveActivityInstances" => true
        },
        {
          "type" => "startBeforeActivity",
          "activityId" => "PreLaudoPriority"
        },
      ],
      "processInstanceIds" => ["fb5f058b-f445-11e9-b73a-0242ac110002", "f5995cae-f445-11e9-835f-0242ac110002"]
    }
  )
end

pool = Concurrent::FixedThreadPool.new(128, fallback_policy: :caller_runs)

# tasks_to_update = Camunda.post("/engine-rest/task", body: tasks_filter)
# process_instance_ids = tasks_to_update.map { |task| task['processInstanceId'] }

response = Camunda.post("/engine-rest/modification/execute", body: modify_body(""))
puts response
